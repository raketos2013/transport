@using System.Security.Claims
@using FileManager.ViewModels
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model GroupsViewModel;
@{
    ViewData["Title"] = "Транспорт: Задачи";
}

<div class="main-content">
    <div class="table-toolbar">
        <div class="toolbar-left">
            <div class="btn-full" onclick="CreateTask()">
                Новая задача
            </div>
            <div class="btn-full" onclick="ShowActiveTask()">
                <span><span id="titleButton">Скрыть </span> неактивные</span>
            </div>
            <div class="btn-full" onclick="CopyTask()">
                Копировать задачу
            </div>
            <a class="btn-full" asp-controller="Task" asp-action="TaskStatuses">
                Статус задач
            </a>
        </div>
        <div class="toolbar-right">
            <div class="input-group">
                <div class="select-wrapper">
                    <select id="select-find-task">
                        <option>Идентификатор</option>
                        <option>Наименование</option>
                        <option>Группа рассылки</option>
                    </select>
                </div>
                <input onkeyup="FindOfTable(document.querySelector('#select-find-task'))" id="input-find-task">
            </div>
        </div>
    </div>
    <div id="tasks">
    </div>
</div>
<footer>
    <div class="pagination">
    </div>
</footer>
<div class="modal-wrapper" id="modal-active-task">
    <div class="modal">
        <div class="modal-header">
            <p><span id="titleInfo"></span> задачу <span id="idTaskInfo"></span>?</p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CancelOnOffTask()">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div class="modal-body">
            <div class="modal-body-content">
            </div>
        </div>
        <div class="modal-footer">
            <div class="btn-full" onclick="OkOnOffTask()">
                Ок
            </div>
        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-delete-task">
    <div class="modal">
        <div class="modal-header">
            <p>Удалить задачу <span id="idTaskDelInfo"></span> ?</p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CancelDeleteTask()">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div class="modal-body">
            <div class="modal-body-content">
            </div>
        </div>
        <div class="modal-footer">
            <div class="btn-full" onclick="OkDeleteTask()">
                Ок
            </div>
        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-add-task">
    <div class="modal">
        <div class="modal-header">
            <p>Создание задачи</p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CloseModal('modal-add-task')">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div class="modal-body" id="create-task-content">
        </div>
        <div class="modal-footer">
            <button type="submit" form="createTaskForm" class="btn-full">
                Сохранить
            </button>
        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-task-info">
    <div class="modal">
        <div class="modal-header">
            <p>Информация о задаче</p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CloseModal('modal-task-info')">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div class="modal-body" id="task-details-content">
        </div>
        <div class="modal-footer">
            <div class="btn-full" onclick="EditTask(getCookie('selectedTask'))">
                Редактировать
            </div>
        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-edit-task">
    <div class="modal">
        <div id="edit-task-content">

        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-copy-task">
    <div class="modal">
        <div class="modal-header">
            <p>Копирование задачи <span id="copied-taskId"></span></p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CloseModal('modal-copy-task'), UnlockTask()">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div id="copy-steps-content">

        </div>
        
        <div class="modal-footer">
            <div class="btn-full" onclick="CloseModal('modal-copy-task')">
                Отмена
            </div>
            <button type="submit" form="copy-task-form" class="btn-full" onclick="CloseModal('modal-copy-task')">
                Ок
            </button>
        </div>
    </div>
</div>
<div class="modal-wrapper" id="modal-change-limit">
    <div class="modal">
        <div class="modal-header">
            <p>Лимит выполнений задачи <span id="idTaskLimitInfo"></span></p>
            <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="CloseModal('modal-change-limit'), UnlockTask()">
                <path d="M5.19281 4.69635L8 7.50342L10.7926 4.71089C10.8543 4.64524 10.9286 4.59272 11.0111 4.55648C11.0936 4.52024 11.1825 4.50103 11.2726 4.5C11.4655 4.5 11.6505 4.57662 11.7869 4.713C11.9233 4.84938 11.9999 5.03435 11.9999 5.22722C12.0016 5.31638 11.985 5.40494 11.9513 5.48748C11.9175 5.57001 11.8672 5.64478 11.8035 5.70719L8.97452 8.49971L11.8035 11.3286C11.9234 11.4459 11.9937 11.6046 11.9999 11.7722C11.9999 11.9651 11.9233 12.15 11.7869 12.2864C11.6505 12.4228 11.4655 12.4994 11.2726 12.4994C11.1799 12.5033 11.0875 12.4878 11.0011 12.454C10.9147 12.4202 10.8363 12.3688 10.7708 12.3031L8 9.496L5.20008 12.2958C5.13863 12.3593 5.06522 12.4099 4.98409 12.4449C4.90296 12.4798 4.8157 12.4984 4.72737 12.4994C4.53449 12.4994 4.34951 12.4228 4.21313 12.2864C4.07674 12.15 4.00012 11.9651 4.00012 11.7722C3.99842 11.683 4.01497 11.5945 4.04873 11.5119C4.0825 11.4294 4.13277 11.3546 4.19648 11.2922L7.02548 8.49971L4.19648 5.67082C4.07661 5.55357 4.00633 5.39478 4.00012 5.22722C4.00012 5.03435 4.07674 4.84938 4.21313 4.713C4.34951 4.57662 4.53449 4.5 4.72737 4.5C4.90191 4.50218 5.06918 4.57272 5.19281 4.69635Z" fill="white" />
            </svg>
        </div>
        <div class="modal-body">
            <div class="modal-body-content">
                <form method="post" id="form-limit-task" asp-controller="Task" asp-action="LimitTask">
                    <input type="text" name="taskId" id="limit-taskId" hidden/>
                    <div class="input-with-label">
                        <input name="limit" type="number" min="0"/>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" form="form-limit-task" class="btn-full" onclick="CloseModal('modal-change-limit')">
                Ок
            </button>
        </div>
    </div>
</div>



<script>

    window.addEventListener('load', () => {
        // var cookieGroup = getCookie("selectedTaskGroup");
        // if(cookieGroup != undefined){
        //     selectGroup = cookieGroup;
        // }
        //document.getElementById('breadcrumbs-taskgroup').innerText = selectGroup;
        ShowTaskList();
        func();

    });
    function func() {
        window.progressID = setInterval(f1, 10000);
    }
    function f1() {
        ShowTaskList();
    }
    function ShowTaskList() {
        // selectGroup = group;
        // document.getElementById('breadcrumbs-taskgroup').innerText = selectGroup;
        //document.cookie = "selectedTaskGroup=" + group;
        $.ajax({
            method: 'POST',
            url: '@Url.Action("TasksList", "Task")',
            data: { 
                //"taskGroup": selectGroup 
            },
            dataType: 'html',
            success: function (result) {
                $('#tasks').empty();
                $('#tasks').append(result);
                SelectRow("tableTasks");
                cookieTask = getCookie("selectedTask");
                tableTasks = document.getElementById("tableTasks");
                tr = tableTasks.getElementsByTagName("tr");
                for (var i = 0; i < tr.length; i++) {
                    var td = tr[i].getElementsByTagName("td")[1];
                    if (td.innerText == cookieTask) {
                        tr[i].classList.add('selected-tr');
                    } else{
                        tr[i].classList.remove('selected-tr');
                    }
                }
            }
        });
    }

    var isActivatedTask;
    function OnOffTask(id) {

        // Объявить переменные
        var table, tr, td, i, txtValue;

        table = document.getElementById("tableTasks");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                txtValue = td.innerText;
                if (txtValue == id) {
                    var qwe = tr[i].getElementsByTagName("td")[7];
                    var chl1 = qwe.firstElementChild.firstElementChild.firstElementChild.checked;
                    isActivatedTask = chl1;
                }
            }
        }
        if (chl1 == true) {
            document.getElementById('titleInfo').innerText = "Включить";
        } else {
            document.getElementById('titleInfo').innerText = "Выключить";
        }
        document.getElementById('idTaskInfo').innerText = id;

    }


    function OkOnOffTask() {
        var cookieTaskId = getCookie("selectedTask");
        $.ajax({
            method: 'GET',
            url: '/Task/IsLockedTask',
            data: {
                "taskId": cookieTaskId
            },
            dataType: 'html',
            success: function (result) {
                let jsonObj = JSON.parse(result)
                if (jsonObj.isLocked == false) {
                    
                    var id = document.getElementById('idTaskInfo').innerText
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("ActivatedTask", "Task")',
                        data: { "id": id },
                        dataType: 'html',
                        success: function (result) {
                            f1();
                            CloseModal('modal-active-task')
                        }
                    });
                } else if (jsonObj.isLocked == true) {
                    ShowModal('modal-locked-task')
                    document.getElementById('userId-locked-task').innerText = jsonObj.userId
                }

            }
        });
    }

    function CancelOnOffTask() {
        CloseModal('modal-active-task')
        var table, tr, td, i, txtValue;

        table = document.getElementById("tableTasks");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                txtValue = td.innerText;
                if (txtValue == document.getElementById('idTaskInfo').innerText) {
                    var qwe = tr[i].getElementsByTagName("td")[7];
                    qwe.firstElementChild.firstElementChild.firstElementChild.checked = !isActivatedTask;

                }
            }
        }

    }

    function FindOfTable(select) {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("input-find-task");
        filter = input.value.toUpperCase();
        table = document.getElementById("tableTasks");
        tr = table.getElementsByTagName("tr");

        var col = select.selectedIndex + 1;
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[col];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

</script>